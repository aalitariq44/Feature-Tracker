<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متتبع حالة الميزات</title>
    <!-- Tailwind CSS via Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for disabled form elements */
        :disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">لوحة تتبع الميزات</h1>
            <p class="text-slate-600 mt-2">أداة بسيطة لتنظيم وتتبع حالة ميزات تطبيقاتك.</p>
            <div id="feature-counts" class="flex justify-center gap-4 mb-4"></div>
            <div id="suggestion-counts" class="flex justify-center gap-4 mb-4"></div>
        </header>

        <!-- منطقة الإدخال -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-3 text-slate-800">إضافة جديد</h2>
            
            <!-- نموذج إضافة الميزات -->
            <form id="add-feature-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="feature-name" class="block text-sm font-medium text-slate-700 mb-1">اسم الميزة</label>
                    <input type="text" id="feature-name" placeholder="مثال: تسجيل الدخول بالبريد" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div>
                    <label for="select-group" class="block text-sm font-medium text-slate-700 mb-1">اختر مجموعة</label>
                    <select id="select-group" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                </div>
                <div>
                    <label for="feature-status" class="block text-sm font-medium text-slate-700 mb-1">الحالة</label>
                    <select id="feature-status" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="excellent">ممتاز</option>
                        <option value="good">جيد</option>
                        <option value="bad">سيء</option>
                        <option value="not-working">لا تعمل</option>
                    </select>
                </div>
                <button type="submit" id="add-feature-btn" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                    إضافة ميزة
                </button>
            </form>

            <div class="border-t my-6"></div>

            <!-- نموذج إضافة مجموعة -->
            <form id="add-group-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                 <div class="md:col-span-4">
                    <label for="group-name" class="block text-sm font-medium text-slate-700 mb-1">اسم مجموعة جديد</label>
                    <input type="text" id="group-name" placeholder="مثال: ميزات لوحة التحكم" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                </div>
                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-300">
                    إنشاء مجموعة
                </button>
            </form>
            <!-- نموذج إضافة اقتراح -->
            <form id="add-suggestion-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-8">
                <div class="md:col-span-2">
                    <label for="suggestion-name" class="block text-sm font-medium text-slate-700 mb-1">اسم الاقتراح</label>
                    <input type="text" id="suggestion-name" placeholder="مثال: دعم الوضع الليلي" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div>
                    <label for="select-suggestion-group" class="block text-sm font-medium text-slate-700 mb-1">اختر مجموعة</label>
                    <select id="select-suggestion-group" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                </div>
                <div>
                    <label for="suggestion-type" class="block text-sm font-medium text-slate-700 mb-1">نوع الاقتراح</label>
                    <select id="suggestion-type" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="necessary">ضرورية</option>
                        <option value="future">مستقبلية</option>
                    </select>
                </div>
                <button type="submit" id="add-suggestion-btn" class="w-full bg-purple-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-300">
                    إضافة اقتراح
                </button>
            </form>
        </div>

        <!-- منطقة عرض المجموعات والميزات -->
        <div id="features-container" class="space-y-6">
            <!-- سيتم إدراج المجموعات هنا بواسطة جافاسكريبت -->
        </div>
        <!-- منطقة عرض الاقتراحات -->
        <div id="suggestions-container" class="space-y-6">
            <!-- سيتم إدراج الاقتراحات هنا بواسطة جافاسكريبت -->
        </div>
        </div>
        <!-- Modal لاختيار المجموعة عند النقل -->
        <div id="group-select-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white rounded-lg p-6 w-80">
                <h3 class="text-lg font-semibold mb-4">اختر المجموعة</h3>
                <select id="group-select-modal-select" class="w-full mb-4 bg-slate-50 border border-slate-300 rounded-lg p-2.5"></select>
                <div class="flex justify-end gap-2">
                    <button id="group-select-modal-cancel" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">إلغاء</button>
                    <button id="group-select-modal-ok" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">موافق</button>
                </div>
            </div>
        </div>
        <!-- Modal لتعديل الميزة أو الاقتراح -->
        <div id="edit-item-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
          <div class="bg-white rounded-lg p-6 w-80">
            <h3 id="edit-item-modal-title" class="text-lg font-semibold mb-4"></h3>
            <div class="mb-4">
              <label class="block mb-1">الاسم</label>
              <input id="edit-item-modal-name" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" />
            </div>
            <div class="mb-4">
              <label id="edit-item-modal-type-label" class="block mb-1">الحالة/النوع</label>
              <select id="edit-item-modal-type" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></select>
            </div>
            <div class="flex justify-end gap-2">
                <button id="edit-item-modal-cancel" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">إلغاء</button>
                <button id="edit-item-modal-ok" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">موافق</button>
            </div>
          </div>
        </div>
        <!-- Modal لعرض المجموعة -->
        <div id="group-view-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
          <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-auto">
            <h3 id="group-view-modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="group-view-modal-content" class="space-y-4"></div>
            <div class="border-t my-4"></div>
            <h4 class="text-lg font-semibold mb-2">إضافة ميزة جديدة</h4>
            <form id="group-view-add-feature-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-4">
              <div class="md:col-span-3">
                <input id="group-view-feature-name" type="text" placeholder="اسم الميزة" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" />
              </div>
              <div>
                <select id="group-view-feature-status" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5">
                  <option value="excellent">ممتاز</option>
                  <option value="good">جيد</option>
                  <option value="bad">سيء</option>
                  <option value="not-working">لا تعمل</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700">إضافة</button>
            </form>
            <div class="border-t my-4"></div>
            <h4 class="text-lg font-semibold mb-2">إضافة اقتراح جديد</h4>
            <form id="group-view-add-suggestion-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end mb-4">
              <div class="md:col-span-3">
                <input id="group-view-suggestion-name" type="text" placeholder="اسم الاقتراح" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" />
              </div>
              <div>
                <select id="group-view-suggestion-type" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5">
                  <option value="necessary">ضرورية</option>
                  <option value="future">مستقبلية</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-purple-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-purple-700">إضافة</button>
            </form>
            <div class="flex justify-end mt-4">
              <button id="group-view-modal-close" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">إغلاق</button>
            </div>
          </div>
        </div>
      </div>
    </body>
    <script>
        // عناصر واجهة الميزات
        const addFeatureForm = document.getElementById('add-feature-form');
        const featureNameInput = document.getElementById('feature-name');
        const featureStatusSelect = document.getElementById('feature-status');
        const selectGroupDropdown = document.getElementById('select-group');
        const addFeatureBtn = document.getElementById('add-feature-btn');
        const featuresContainer = document.getElementById('features-container');
        const addGroupForm = document.getElementById('add-group-form');
        const groupNameInput = document.getElementById('group-name');

        // عناصر واجهة الاقتراحات
        const addSuggestionForm = document.getElementById('add-suggestion-form');
        const suggestionNameInput = document.getElementById('suggestion-name');
        const suggestionTypeSelect = document.getElementById('suggestion-type');
        const selectSuggestionGroupDropdown = document.getElementById('select-suggestion-group');
        const addSuggestionBtn = document.getElementById('add-suggestion-btn');
        const suggestionsContainer = document.getElementById('suggestions-container');

        // عناصر المودال لاختيار المجموعة عند النقل
        const modal = document.getElementById('group-select-modal');
        const modalSelect = document.getElementById('group-select-modal-select');
        const modalOk = document.getElementById('group-select-modal-ok');
        const modalCancel = document.getElementById('group-select-modal-cancel');
        let moveContext = null;

        // عناصر مودال التعديل
        const editModal = document.getElementById('edit-item-modal');
        const editModalTitle = document.getElementById('edit-item-modal-title');
        const editModalNameInput = document.getElementById('edit-item-modal-name');
        const editModalTypeLabel = document.getElementById('edit-item-modal-type-label');
        const editModalTypeSelect = document.getElementById('edit-item-modal-type');
        const editModalOkBtn = document.getElementById('edit-item-modal-ok');
        const editModalCancelBtn = document.getElementById('edit-item-modal-cancel');
        let editContext = null;

        // عناصر مودال عرض المجموعة
        const groupViewModal = document.getElementById('group-view-modal');
        const groupViewTitle = document.getElementById('group-view-modal-title');
        const groupViewContent = document.getElementById('group-view-modal-content');
        const groupViewAddFeatureForm = document.getElementById('group-view-add-feature-form');
        const groupViewFeatureName = document.getElementById('group-view-feature-name');
        const groupViewFeatureStatus = document.getElementById('group-view-feature-status');
        const groupViewAddSuggestionForm = document.getElementById('group-view-add-suggestion-form');
        const groupViewSuggestionName = document.getElementById('group-view-suggestion-name');
        const groupViewSuggestionType = document.getElementById('group-view-suggestion-type');
        const groupViewClose = document.getElementById('group-view-modal-close');
        let currentModalGroup = null;

        const statusConfig = {
            'excellent': { text: 'ممتاز', color: 'bg-green-500', textColor: 'text-green-800', bgColor: 'bg-green-100' },
            'good': { text: 'جيد', color: 'bg-blue-500', textColor: 'text-blue-800', bgColor: 'bg-blue-100' },
            'bad': { text: 'سيء', color: 'bg-yellow-500', textColor: 'text-yellow-800', bgColor: 'bg-yellow-100' },
            'not-working': { text: 'لا تعمل', color: 'bg-red-500', textColor: 'text-red-800', bgColor: 'bg-red-100' }
        };

        let featureGroups = {};
        let suggestedFeatures = {};

        let db;
        const request = indexedDB.open('FeatureTrackerDB', 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('featureStore')) {
                db.createObjectStore('featureStore');
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadData().then(() => {
                renderUI();
            });
        };

        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.errorCode);
            featureGroups = {};
            suggestedFeatures = {};
            renderUI();
        };

        // تحميل البيانات
        function loadData() {
            return new Promise((resolve) => {
                const tx = db.transaction('featureStore', 'readonly');
                const store = tx.objectStore('featureStore');
                const getReq = store.get('featureTrackerData');
                getReq.onsuccess = function() {
                    const data = getReq.result || {};
                    if (data.featureGroups) {
                        featureGroups = data.featureGroups;
                        suggestedFeatures = data.suggestedFeatures || {};
                    } else {
                        featureGroups = data;
                        suggestedFeatures = {};
                    }
                    resolve();
                };
                getReq.onerror = function() {
                    featureGroups = {};
                    suggestedFeatures = {};
                    resolve();
                };
            });
        }

        // حفظ البيانات
        function saveData() {
            const tx = db.transaction('featureStore', 'readwrite');
            const store = tx.objectStore('featureStore');
            store.put({ featureGroups, suggestedFeatures }, 'featureTrackerData');
        }

        /**
         * دالة لتحديث القائمة المنسدلة للمجموعات وحالة نموذج إضافة الميزات
         */
        function renderGroupSelector() {
            const lastSelectedGroup = selectGroupDropdown.value;
            selectGroupDropdown.innerHTML = '';
            const groupKeys = Object.keys(featureGroups);

            if (groupKeys.length === 0) {
                selectGroupDropdown.disabled = true;
                featureNameInput.disabled = true;
                featureStatusSelect.disabled = true;
                addFeatureBtn.disabled = true;
                const option = document.createElement('option');
                option.textContent = 'أنشئ مجموعة أولاً';
                selectGroupDropdown.appendChild(option);
            } else {
                selectGroupDropdown.disabled = false;
                featureNameInput.disabled = false;
                featureStatusSelect.disabled = false;
                addFeatureBtn.disabled = false;
                groupKeys.forEach(groupName => {
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = groupName;
                    selectGroupDropdown.appendChild(option);
                });
                // إعادة تحديد المجموعة التي كانت محددة سابقاً إن وجدت
                if (groupKeys.includes(lastSelectedGroup)) {
                    selectGroupDropdown.value = lastSelectedGroup;
                }
            }
        }

        /**
         * دالة لتحديث القائمة المنسدلة للمجموعات وحالة نموذج إضافة الاقتراحات
         */
        function renderSuggestionGroupSelector() {
            if (!selectSuggestionGroupDropdown) return;
            const last = selectSuggestionGroupDropdown.value || '';
            selectSuggestionGroupDropdown.innerHTML = '';
            const keys = Object.keys(featureGroups);
            if (keys.length === 0) {
                selectSuggestionGroupDropdown.disabled = true;
                suggestionNameInput.disabled = true;
                suggestionTypeSelect.disabled = true;
                addSuggestionBtn.disabled = true;
                const opt = document.createElement('option'); opt.textContent = 'أنشئ مجموعة أولاً';
                selectSuggestionGroupDropdown.appendChild(opt);
            } else {
                selectSuggestionGroupDropdown.disabled = false;
                suggestionNameInput.disabled = false;
                suggestionTypeSelect.disabled = false;
                addSuggestionBtn.disabled = false;
                keys.forEach(name => { const o = document.createElement('option'); o.value = name; o.textContent = name; selectSuggestionGroupDropdown.appendChild(o); });
                if (keys.includes(last)) selectSuggestionGroupDropdown.value = last;
            }
        }

        /**
         * دالة لرسم بطاقات المجموعات والميزات
         */
        function renderFeatureCards() {
            featuresContainer.innerHTML = '';

            if (Object.keys(featureGroups).length === 0) {
                featuresContainer.innerHTML = `
                    <div class="text-center bg-white p-10 rounded-2xl shadow-md">
                        <h3 class="text-xl font-semibold text-slate-700">لم تقم بإضافة أي مجموعات بعد</h3>
                        <p class="text-slate-500 mt-2">استخدم نموذج "إنشاء مجموعة" في الأعلى للبدء.</p>
                    </div>
                `;
                return;
            }
            
            for (const groupName in featureGroups) {
                const group = featureGroups[groupName];
                const groupElement = document.createElement('div');
                groupElement.className = 'bg-white p-6 rounded-2xl shadow-lg';

                const groupHeader = `
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold text-slate-800">${groupName}</h3>
                        <button class="delete-group-btn text-slate-400 hover:text-red-600 transition" data-group="${groupName}" title="حذف المجموعة">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                
                const featuresList = document.createElement('div');
                featuresList.className = 'space-y-3';

                if (group.length > 0) {
                    group.forEach((feature, index) => {
                        const config = statusConfig[feature.status];
                        const featureElement = document.createElement('div');
                        featureElement.className = `flex items-center justify-between p-3 rounded-lg ${config.bgColor}`;
                        
                        featureElement.innerHTML = `
                                            <div class="flex items-center gap-3">
                                                    <span class="status-dot ${config.color}"></span>
                                                    <p class="font-medium text-slate-700">${feature.name}</p>
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <span class="text-sm font-semibold ${config.textColor} px-2 py-1 rounded-full">${config.text}</span>
                                                    <button class="move-feature-btn text-slate-400 hover:text-blue-600 transition" data-group="${groupName}" data-index="${index}" title="نقل الميزة">↔</button>
                                                    <button class="edit-feature-btn text-slate-400 hover:text-yellow-600 transition" data-group="${groupName}" data-index="${index}" title="تعديل الميزة">✎</button>
                                                    <button class="delete-feature-btn text-slate-400 hover:text-red-600 transition" data-group="${groupName}" data-index="${index}" title="حذف الميزة">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        `;
                        featuresList.appendChild(featureElement);
                    });
                } else {
                    featuresList.innerHTML = `<p class="text-slate-500 text-center p-4">لا توجد ميزات في هذه المجموعة بعد.</p>`;
                }
                
                groupElement.innerHTML = groupHeader;
                groupElement.appendChild(featuresList);
                featuresContainer.appendChild(groupElement);
            }
        }

        /**
         * دالة لرسم بطاقات الاقتراحات
         */
        function renderSuggestionCards() {
            suggestionsContainer.innerHTML = '';
            if (Object.keys(suggestedFeatures).length === 0) {
                suggestionsContainer.innerHTML = `
                    <div class="text-center bg-white p-10 rounded-2xl shadow-md">
                        <h3 class="text-xl font-semibold text-slate-700">لم تقم بإضافة أي اقتراحات بعد</h3>
                    </div>`;
                return;
            }
            for (const grp in suggestedFeatures) {
                const arr = suggestedFeatures[grp];
                const el = document.createElement('div'); el.className = 'bg-white p-6 rounded-2xl shadow-lg';
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold text-slate-800">${grp} - اقتراحات</h3>
                    </div>`;
                const list = document.createElement('div'); list.className = 'space-y-3';
                if (arr.length > 0) {
                    arr.forEach((s, index) => {
                        const color = s.type === 'necessary' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                        const text = s.type === 'necessary' ? 'ضرورية' : 'مستقبلية';
                        const item = document.createElement('div');
                        item.className = `flex items-center justify-between p-3 rounded-lg ${color}`;
                        item.innerHTML = `
                            <p class="font-medium text-slate-700">${s.name}</p>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-semibold ${s.type==='necessary'?'text-red-800':'text-gray-800'} px-2 py-1 rounded-full">${text}</span>
                                <button class="move-suggestion-btn text-slate-400 hover:text-blue-600 transition" data-group="${grp}" data-index="${index}" title="نقل الاقتراح">↔</button>
                                <button class="edit-suggestion-btn text-slate-400 hover:text-yellow-600 transition" data-group="${grp}" data-index="${index}" title="تعديل الاقتراح">✎</button>
                                <!-- إضافة زر حذف الاقتراح -->
                                <button class="delete-suggestion-btn text-slate-400 hover:text-red-600 transition" data-group="${grp}" data-index="${index}" title="حذف الاقتراح">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = `<p class="text-slate-500 text-center p-4">لا توجد اقتراحات في هذه المجموعة بعد.</p>`;
                }
                el.appendChild(list);
                suggestionsContainer.appendChild(el);
            }
        }

        // Add function to render feature status counts
        function renderFeatureCounts() {
            const counts = { 'excellent': 0, 'good': 0, 'bad': 0, 'not-working': 0 };
            for (const group of Object.values(featureGroups)) {
                group.forEach(f => {
                    if (counts.hasOwnProperty(f.status)) {
                        counts[f.status]++;
                    }
                });
            }
            const countsContainer = document.getElementById('feature-counts');
            countsContainer.innerHTML = Object.entries(counts).map(([status, count]) => {
                const cfg = statusConfig[status];
                return `<div class="flex items-center gap-2"><span class="status-dot ${cfg.color}"></span><span class="font-medium text-slate-700">${cfg.text}: ${count}</span></div>`;
            }).join('');
        }

        // Add function to render total suggestion count
        function renderSuggestionCounts() {
            let totalSuggestions = 0;
            Object.values(suggestedFeatures).forEach(arr => { totalSuggestions += arr.length; });
            const suggContainer = document.getElementById('suggestion-counts');
            suggContainer.innerHTML = `<div class="font-medium text-slate-700">الاقتراحات: ${totalSuggestions}</div>`;
        }

        /**
         * دالة رئيسية لإعادة رسم الواجهة بالكامل
         */
        function renderUI() {
            // Render counts at top
            renderFeatureCounts();
            renderSuggestionCounts();
            renderGroupSelector();
            renderSuggestionGroupSelector();
            renderFeatureCards();
            renderSuggestionCards();
        }
        
        addGroupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newGroupName = groupNameInput.value.trim();
            if (newGroupName && !featureGroups[newGroupName]) {
                featureGroups[newGroupName] = [];
                saveData();
                renderUI();
                // تحديد المجموعة الجديدة في القائمة المنسدلة
                selectGroupDropdown.value = newGroupName;
                groupNameInput.value = '';
            } else if (featureGroups[newGroupName]) {
                alert('هذه المجموعة موجودة بالفعل!');
            }
        });

        addFeatureForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const featureName = featureNameInput.value.trim();
            const featureStatus = featureStatusSelect.value;
            const targetGroup = selectGroupDropdown.value;
            
            if (!targetGroup) {
                alert('يجب عليك اختيار مجموعة أولاً!');
                return;
            }
            
            if (featureName) {
                featureGroups[targetGroup].push({ name: featureName, status: featureStatus });
                saveData();
                renderUI();
                featureNameInput.value = '';
            }
        });

        // حدث إرسال نموذج الاقتراح
        addSuggestionForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = suggestionNameInput.value.trim();
            const type = suggestionTypeSelect.value;
            const grp = selectSuggestionGroupDropdown.value;
            if (!grp) { alert('يجب عليك اختيار مجموعة أولاً!'); return; }
            if (name) {
                if (!suggestedFeatures[grp]) suggestedFeatures[grp] = [];
                suggestedFeatures[grp].push({ name, type });
                saveData(); renderUI(); suggestionNameInput.value = '';
            }
        });

        featuresContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            if (target.classList.contains('delete-feature-btn')) {
                const groupName = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                if (confirm(`هل أنت متأكد من حذف هذه الميزة؟`)) {
                    featureGroups[groupName].splice(index, 1);
                    saveData();
                    renderUI();
                }
            }
            if (target.classList.contains('edit-feature-btn')) {
                const groupName = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                const feature = featureGroups[groupName][index];
                editContext = { type: 'feature', groupName, index, originalName: feature.name, originalStatus: feature.status };
                editModalTitle.textContent = 'تعديل الميزة';
                editModalNameInput.value = feature.name;
                editModalTypeLabel.textContent = 'الحالة';
                editModalTypeSelect.innerHTML = `
                    <option value="excellent">ممتاز</option>
                    <option value="good">جيد</option>
                    <option value="bad">سيء</option>
                    <option value="not-working">لا تعمل</option>
                `;
                editModalTypeSelect.value = feature.status;
                editModal.classList.remove('hidden');
            }
            if (target.classList.contains('move-feature-btn')) {
                const oldGroup = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                moveContext = { type: 'feature', oldGroup, index };
                // Populate modal select with groups (disable current)
                modalSelect.innerHTML = '';
                Object.keys(featureGroups).forEach(name => {
                    const o = document.createElement('option');
                    o.value = name;
                    o.textContent = name;
                    if (name === oldGroup) o.disabled = true;
                    modalSelect.appendChild(o);
                });
                modalSelect.value = oldGroup;
                // Show modal
                modal.classList.remove('hidden');
            }

            if (target.classList.contains('delete-group-btn')) {
                const groupName = target.dataset.group;
                if (confirm(`هل أنت متأكد من حذف مجموعة "${groupName}" وكل الميزات بداخلها؟`)) {
                    delete featureGroups[groupName];
                    saveData();
                    renderUI();
                }
            }
        });

        // Initial rendering is handled after IndexedDB load

        // التعامل مع نقل المقترحات عبر المودال
        suggestionsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            if (target.classList.contains('move-suggestion-btn')) {
                const oldGroup = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                moveContext = { type: 'suggestion', oldGroup, index };
                // تعبئة المودال
                modalSelect.innerHTML = '';
                Object.keys(featureGroups).forEach(name => {
                    const o = document.createElement('option');
                    o.value = name;
                    o.textContent = name;
                    if (name === oldGroup) o.disabled = true;
                    modalSelect.appendChild(o);
                });
                modalSelect.value = oldGroup;
                modal.classList.remove('hidden');
            }
            if (target.classList.contains('edit-suggestion-btn')) {
                const oldGroup = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                const suggestion = suggestedFeatures[oldGroup][index];
                editContext = { type: 'suggestion', groupName: oldGroup, index, originalName: suggestion.name, originalType: suggestion.type };
                editModalTitle.textContent = 'تعديل الاقتراح';
                editModalNameInput.value = suggestion.name;
                editModalTypeLabel.textContent = 'النوع';
                editModalTypeSelect.innerHTML = `
                    <option value="necessary">ضرورية</option>
                    <option value="future">مستقبلية</option>
                `;
                editModalTypeSelect.value = suggestion.type;
                editModal.classList.remove('hidden');
            }
            // إضافة زر حذف الاقتراح
            if (target.classList.contains('delete-suggestion-btn')) {
                const group = target.dataset.group;
                const index = parseInt(target.dataset.index, 10);
                if (confirm('هل أنت متأكد من حذف هذا الاقتراح؟')) {
                    suggestedFeatures[group].splice(index, 1);
                    saveData();
                    renderUI();
                }
            }
        });

        // أزرار التحكم في المودال
        modalCancel.addEventListener('click', () => {
            modal.classList.add('hidden');
            moveContext = null;
        });
        modalOk.addEventListener('click', () => {
            const newGroup = modalSelect.value;
            if (moveContext) {
                const { type, oldGroup, index } = moveContext;
                if (type === 'feature') {
                    const item = featureGroups[oldGroup][index];
                    if (featureGroups[newGroup]) {
                        featureGroups[oldGroup].splice(index, 1);
                        featureGroups[newGroup].push(item);
                    }
                } else if (type === 'suggestion') {
                    const item = suggestedFeatures[oldGroup][index];
                    if (!suggestedFeatures[newGroup]) suggestedFeatures[newGroup] = [];
                    suggestedFeatures[oldGroup].splice(index, 1);
                    suggestedFeatures[newGroup].push(item);
                }
                saveData();
                renderUI();
            }
            modal.classList.add('hidden');
            moveContext = null;
        });

        // أزرار التحكم في مودال التعديل
        editModalCancelBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
            editContext = null;
        });

        editModalOkBtn.addEventListener('click', () => {
            if (editContext) {
                const newName = editModalNameInput.value.trim();
                const newTypeOrStatus = editModalTypeSelect.value;

                if (!newName) {
                    alert('الاسم لا يمكن أن يكون فارغاً!');
                    return;
                }

                if (editContext.type === 'feature') {
                    featureGroups[editContext.groupName][editContext.index].name = newName;
                    featureGroups[editContext.groupName][editContext.index].status = newTypeOrStatus;
                } else if (editContext.type === 'suggestion') {
                    suggestedFeatures[editContext.groupName][editContext.index].name = newName;
                    suggestedFeatures[editContext.groupName][editContext.index].type = newTypeOrStatus;
                }
                saveData();
                renderUI();
            }
            editModal.classList.add('hidden');
            editContext = null;
        });

        function openGroupModal(groupName) {
          currentModalGroup = groupName;
          groupViewTitle.textContent = groupName;
          let html = '';
          // features list
          const feats = featureGroups[groupName] || [];
          html += '<div class="space-y-3">';
          if (feats.length) {
            feats.forEach(f => {
              const cfg = statusConfig[f.status];
              html += `<div class="flex items-center justify-between p-3 rounded-lg ${cfg.bgColor}">` +
                      `<div class="flex items-center gap-3"><span class="status-dot ${cfg.color}"></span><p class="font-medium text-slate-700">${f.name}</p></div>` +
                      `<span class="text-sm font-semibold ${cfg.textColor} px-2 py-1 rounded-full">${cfg.text}</span></div>`;
            });
          } else {
            html += `<p class="text-slate-500 text-center p-4">لا توجد ميزات في هذه المجموعة بعد.</p>`;
          }
          html += '</div>';
          // suggestions list
          const sugs = suggestedFeatures[groupName] || [];
          html += '<div class="mt-4 space-y-3">';
          if (sugs.length) {
            sugs.forEach(s => {
              const cls = s.type === 'necessary' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800';
              html += `<div class="flex items-center justify-between p-3 rounded-lg ${cls}"><p class="font-medium text-slate-700">${s.name}</p>` +
                      `<span class="text-sm font-semibold ${cls} px-2 py-1 rounded-full">${s.type==='necessary'?'ضرورية':'مستقبلية'}</span></div>`;
            });
          } else {
            html += `<p class="text-slate-500 text-center p-4">لا توجد اقتراحات في هذه المجموعة بعد.</p>`;
          }
          html += '</div>';
          groupViewContent.innerHTML = html;
          // reset forms
          groupViewAddFeatureForm.reset();
          groupViewAddSuggestionForm.reset();
          groupViewModal.classList.remove('hidden');
        }

        // attach click to group headers
        function enhanceGroupClicks() {
          document.querySelectorAll('#features-container .bg-white.p-6.rounded-2xl.shadow-lg > .flex.border-b .text-xl').forEach(el => {
            // fallback selector, better to use data attribute
          });
        }

        // Close modal
        groupViewClose.addEventListener('click', () => {
          groupViewModal.classList.add('hidden');
        });

        // feature add in modal
        groupViewAddFeatureForm.addEventListener('submit', e => {
          e.preventDefault();
          const name = groupViewFeatureName.value.trim();
          const status = groupViewFeatureStatus.value;
          if (!name) return alert('الاسم لا يمكن أن يكون فارغاً!');
          featureGroups[currentModalGroup].push({ name, status });
          saveData(); renderUI(); openGroupModal(currentModalGroup);
        });

        // suggestion add in modal
        groupViewAddSuggestionForm.addEventListener('submit', e => {
          e.preventDefault();
          const name = groupViewSuggestionName.value.trim();
          const type = groupViewSuggestionType.value;
          if (!name) return alert('الاسم لا يمكن أن يكون فارغاً!');
          if (!suggestedFeatures[currentModalGroup]) suggestedFeatures[currentModalGroup] = [];
          suggestedFeatures[currentModalGroup].push({ name, type });
          saveData(); renderUI(); openGroupModal(currentModalGroup);
        });

        // modify renderFeatureCards to attach click
        const originalRender = renderFeatureCards;
        renderFeatureCards = function() {
          originalRender();
          document.querySelectorAll('#features-container h3.text-xl').forEach(h3 => {
            const grp = h3.textContent;
            h3.style.cursor = 'pointer';
            h3.addEventListener('click', () => openGroupModal(grp));
          });
        };
    </script>
  </html>
